defmodule ElixirGodotParsersTest do
  use ExUnit.Case

  alias ElixirGodot, as: Parser

  defmodule ElixirGodotParsersTest do
    use ExUnit.Case

    alias ElixirGodot, as: Parser

    @gd_resource """
    [gd_scene load_steps=5 format=3 uid="uid://b2agmmarkv5l3"]

    [sub_resource type="StandardMaterial3D" id="StandardMaterial3D_jln1w"]
    resource_name = "Material"
    cull_mode = 2
    vertex_color_use_as_albedo = true
    albedo_color = Color(0.906332, 0.906332, 0.906332, 1)
    roughness = 0.4
    emission_enabled = true

    [sub_resource type="ArrayMesh" id="ArrayMesh_kd3hq"]
    _surfaces = [{
    "aabb": AABB(-1, -1, -1, 2.00001, 2.00001, 2),
    "format": 4097,
    "index_count": 36,
    "index_data": PackedByteArray(0, 0, 2, 0, 1, 0, 0, 0, 3, 0, 2, 0, 4, 0, 2, 0, 3, 0, 4, 0, 5, 0, 2, 0, 5, 0, 1, 0, 2, 0, 5, 0, 6, 0, 1, 0, 6, 0, 4, 0, 7, 0, 6, 0, 5, 0, 4, 0, 7, 0, 3, 0, 0, 0, 7, 0, 4, 0, 3, 0, 6, 0, 0, 0, 1, 0, 6, 0, 7, 0, 0, 0),
    "name": "Material",
    "primitive": 3,
    "vertex_count": 8,
    "vertex_data": PackedByteArray(0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 128, 191, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 128, 191, 0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 128, 191, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 128, 191, 0, 0, 128, 191, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 128, 191)
    }]
    blend_shape_mode = 0

    [sub_resource type="ArrayMesh" id="ArrayMesh_uvbey"]
    resource_name = "Main scene_Cube"
    _surfaces = [{
    "aabb": AABB(-1, -1, -1, 2.00001, 2.00001, 2),
    "attribute_data": PackedByteArray(0, 0, 32, 63, 0, 0, 0, 63, 0, 0, 96, 63, 0, 0, 0, 63, 0, 0, 96, 63, 0, 0, 128, 62, 0, 0, 32, 63, 0, 0, 128, 62, 0, 0, 192, 62, 0, 0, 128, 62, 0, 0, 32, 63, 0, 0, 128, 62, 0, 0, 32, 63, 0, 0, 0, 0, 0, 0, 192, 62, 0, 0, 0, 0, 0, 0, 192, 62, 0, 0, 128, 63, 0, 0, 32, 63, 0, 0, 128, 63, 0, 0, 32, 63, 0, 0, 64, 63, 0, 0, 192, 62, 0, 0, 64, 63, 0, 0, 0, 62, 0, 0, 0, 63, 0, 0, 192, 62, 0, 0, 0, 63, 0, 0, 192, 62, 0, 0, 128, 62, 0, 0, 0, 62, 0, 0, 128, 62, 0, 0, 192, 62, 0, 0, 0, 63, 0, 0, 32, 63, 0, 0, 0, 63, 0, 0, 32, 63, 0, 0, 128, 62, 0, 0, 192, 62, 0, 0, 128, 62, 0, 0, 192, 62, 0, 0, 64, 63, 0, 0, 32, 63, 0, 0, 64, 63, 0, 0, 32, 63, 0, 0, 0, 63, 0, 0, 192, 62, 0, 0, 0, 63),
    "format": 4119,
    "index_count": 36,
    "index_data": PackedByteArray(0, 0, 2, 0, 1, 0, 0, 0, 3, 0, 2, 0, 4, 0, 6, 0, 5, 0, 4, 0, 7, 0, 6, 0, 8, 0, 10, 0, 9, 0, 8, 0, 11, 0, 10, 0, 12, 0, 14, 0, 13, 0, 12, 0, 15, 0, 14, 0, 16, 0, 18, 0, 17, 0, 16, 0, 19, 0, 18, 0, 20, 0, 22, 0, 21, 0, 20, 0, 23, 0, 22, 0),
    "material": SubResource("StandardMaterial3D_jln1w"),
    "name": "Material",
    "primitive": 3,
    "vertex_count": 24,
    "vertex_data": PackedByteArray(0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 128, 191, 255, 127, 255, 255, 0, 0, 255, 191, 0, 0, 128, 191, 0, 0, 128, 63, 0, 0, 128, 191, 255, 127, 255, 255, 0, 0, 255, 191, 0, 0, 128, 191, 0, 0, 128, 63, 0, 0, 128, 63, 255, 127, 255, 255, 0, 0, 255, 191, 0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 128, 63, 255, 127, 255, 255, 0, 0, 255, 191, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 128, 63, 255, 127, 255, 127, 255, 127, 255, 255, 0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 128, 63, 255, 127, 255, 127, 255, 127, 255, 255, 0, 0, 128, 191, 0, 0, 128, 63, 0, 0, 128, 63, 255, 127, 255, 127, 255, 127, 255, 255, 0, 0, 128, 191, 0, 0, 128, 191, 0, 0, 128, 63, 255, 127, 255, 127, 255, 127, 255, 255, 0, 0, 128, 191, 0, 0, 128, 191, 0, 0, 128, 63, 0, 0, 255, 127, 255, 127, 255, 255, 0, 0, 128, 191, 0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 255, 127, 255, 127, 255, 255, 0, 0, 128, 191, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 255, 127, 255, 127, 255, 255, 0, 0, 128, 191, 0, 0, 128, 191, 0, 0, 128, 191, 0, 0, 255, 127, 255, 127, 255, 255, 0, 0, 128, 191, 0, 0, 128, 191, 0, 0, 128, 191, 255, 127, 0, 0, 255, 255, 255, 191, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 128, 191, 255, 127, 0, 0, 255, 255, 255, 191, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 128, 63, 255, 127, 0, 0, 255, 255, 255, 191, 0, 0, 128, 191, 0, 0, 128, 191, 0, 0, 128, 63, 255, 127, 0, 0, 255, 255, 255, 191, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 128, 191, 255, 255, 255, 127, 255, 127, 255, 255, 0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 128, 191, 255, 255, 255, 127, 255, 127, 255, 255, 0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 128, 63, 255, 255, 255, 127, 255, 127, 255, 255, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 128, 63, 255, 255, 255, 127, 255, 127, 255, 255, 0, 0, 128, 191, 0, 0, 128, 191, 0, 0, 128, 191, 255, 255, 255, 255, 255, 127, 255, 255, 0, 0, 128, 191, 0, 0, 128, 63, 0, 0, 128, 191, 255, 255, 255, 255, 255, 127, 255, 255, 0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 128, 191, 255, 255, 255, 255, 255, 127, 255, 255, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 128, 191, 255, 255, 255, 255, 255, 127, 255, 255)
    }]
    blend_shape_mode = 0
    shadow_mesh = SubResource("ArrayMesh_kd3hq")

    [sub_resource type="ConcavePolygonShape3D" id="ConcavePolygonShape3D_0hx5e"]
    data = PackedVector3Array(1, 1, -1, -1, 1, 1, -1, 1, -1, 1, 1, -1, 1, 1, 1, -1, 1, 1, 1, -1, 1, -1, 1, 1, 1, 1, 1, 1, -1, 1, -1, -1, 1, -1, 1, 1, -1, -1, 1, -1, 1, -1, -1, 1, 1, -1, -1, 1, -1, -1, -1, -1, 1, -1, -1, -1, -1, 1, -1, 1, 1, -1, -1, -1, -1, -1, -1, -1, 1, 1, -1, 1, 1, -1, -1, 1, 1, 1, 1, 1, -1, 1, -1, -1, 1, -1, 1, 1, 1, 1, -1, -1, -1, 1, 1, -1, -1, 1, -1, -1, -1, -1, 1, -1, -1, 1, 1, -1)

    [node name="43563-asset-collection-test" type="Node3D"]

    [node name="Cube" type="MeshInstance3D" parent="."]
    mesh = SubResource("ArrayMesh_uvbey")
    skeleton = NodePath("")

    [node name="@StaticBody3D@17978" type="StaticBody3D" parent="."]
    transform = Transform3D(1.07654, 0, 0, 0, 1.07654, 0, 0, 0, 1.07654, 0.00326128, -0.0227434, 0.0210888)

    [node name="CollisionShape3D" type="CollisionShape3D" parent="@StaticBody3D@17978"]
    shape = SubResource("ConcavePolygonShape3D_0hx5e")

    [node name="Collection" type="Node3D" parent="."]
    transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 1.25045, 0.302781, -1.53633)

    [node name="Collection_001" type="Node3D" parent="."]
    transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 1.37902, 0.303581, 1.58606)

    [node name="asset-box" type="Node3D" parent="."]
    transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -1.44183, 0.258232, -1.58591)

    [node name="asset-box_001" type="Node3D" parent="."]
    transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -1.32259, 0.258232, 1.56816)

    [node name="asset-box_002" type="Node3D" parent="."]
    transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 2.45399, 0)
    """

    test "tscn_parser/1" do
      assert {
               :ok,
               [
                 gd_scene: [
                   section: [
                     "[",
                     "gd_scene",
                     " ",
                     {:key_value, [{:key, ["load_steps"]}, "=", {:value, [number: ~c"5"]}]},
                     " ",
                     {:key_value, [{:key, ["format"]}, "=", {:value, [number: ~c"3"]}]},
                     " ",
                     {
                       :key_value,
                       [
                         {:key, ["uid"]},
                         "=",
                         {
                           :value,
                           [
                             "\"",
                             "uid://",
                             {:alphanum, ~c"b"},
                             {:alphanum, ~c"2"},
                             {:alphanum, ~c"a"},
                             {:alphanum, ~c"g"},
                             {:alphanum, ~c"m"},
                             {:alphanum, ~c"m"},
                             {:alphanum, ~c"a"},
                             {:alphanum, ~c"r"},
                             {:alphanum, ~c"k"},
                             {:alphanum, ~c"v"},
                             {:alphanum, ~c"5"},
                             {:alphanum, ~c"l"},
                             {:alphanum, ~c"3"},
                             "\""
                           ]
                         }
                       ]
                     },
                     "]",
                     {:section_terminator, ["\r\n"]}
                   ]
                 ]
               ],
               "\r\n[sub_resource type=\"StandardMaterial3D\" id=\"StandardMaterial3D_jln1w\"]\r\nresource_name = \"Material\"\r\ncull_mode = 2\r\nvertex_color_use_as_albedo = true\r\nalbedo_color = Color(0.906332, 0.906332, 0.906332, 1)\r\nroughness = 0.4\r\nemission_enabled = true\r\n\r\n[sub_resource type=\"ArrayMesh\" id=\"ArrayMesh_kd3hq\"]\r\n_surfaces = [{\r\n\"aabb\": AABB(-1, -1, -1, 2.00001, 2.00001, 2),\r\n\"format\": 4097,\r\n\"index_count\": 36,\r\n\"index_data\": PackedByteArray(0, 0, 2, 0, 1, 0, 0, 0, 3, 0, 2, 0, 4, 0, 2, 0, 3, 0, 4, 0, 5, 0, 2, 0, 5, 0, 1, 0, 2, 0, 5, 0, 6, 0, 1, 0, 6, 0, 4, 0, 7, 0, 6, 0, 5, 0, 4, 0, 7, 0, 3, 0, 0, 0, 7, 0, 4, 0, 3, 0, 6, 0, 0, 0, 1, 0, 6, 0, 7, 0, 0, 0),\r\n\"name\": \"Material\",\r\n\"primitive\": 3,\r\n\"vertex_count\": 8,\r\n\"vertex_data\": PackedByteArray(0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 128, 191, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 128, 191, 0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 128, 191, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 128, 191, 0, 0, 128, 191, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 128, 191)\r\n}]\r\nblend_shape_mode = 0\r\n\r\n[sub_resource type=\"ArrayMesh\" id=\"ArrayMesh_uvbey\"]\r\nresource_name = \"Main scene_Cube\"\r\n_surfaces = [{\r\n\"aabb\": AABB(-1, -1, -1, 2.00001, 2.00001, 2),\r\n\"attribute_data\": PackedByteArray(0, 0, 32, 63, 0, 0, 0, 63, 0, 0, 96, 63, 0, 0, 0, 63, 0, 0, 96, 63, 0, 0, 128, 62, 0, 0, 32, 63, 0, 0, 128, 62, 0, 0, 192, 62, 0, 0, 128, 62, 0, 0, 32, 63, 0, 0, 128, 62, 0, 0, 32, 63, 0, 0, 0, 0, 0, 0, 192, 62, 0, 0, 0, 0, 0, 0, 192, 62, 0, 0, 128, 63, 0, 0, 32, 63, 0, 0, 128, 63, 0, 0, 32, 63, 0, 0, 64, 63, 0, 0, 192, 62, 0, 0, 64, 63, 0, 0, 0, 62, 0, 0, 0, 63, 0, 0, 192, 62, 0, 0, 0, 63, 0, 0, 192, 62, 0, 0, 128, 62, 0, 0, 0, 62, 0, 0, 128, 62, 0, 0, 192, 62, 0, 0, 0, 63, 0, 0, 32, 63, 0, 0, 0, 63, 0, 0, 32, 63, 0, 0, 128, 62, 0, 0, 192, 62, 0, 0, 128, 62, 0, 0, 192, 62, 0, 0, 64, 63, 0, 0, 32, 63, 0, 0, 64, 63, 0, 0, 32, 63, 0, 0, 0, 63, 0, 0, 192, 62, 0, 0, 0, 63),\r\n\"format\": 4119,\r\n\"index_count\": 36,\r\n\"index_data\": PackedByteArray(0, 0, 2, 0, 1, 0, 0, 0, 3, 0, 2, 0, 4, 0, 6, 0, 5, 0, 4, 0, 7, 0, 6, 0, 8, 0, 10, 0, 9, 0, 8, 0, 11, 0, 10, 0, 12, 0, 14, 0, 13, 0, 12, 0, 15, 0, 14, 0, 16, 0, 18, 0, 17, 0, 16, 0, 19, 0, 18, 0, 20, 0, 22, 0, 21, 0, 20, 0, 23, 0, 22, 0),\r\n\"material\": SubResource(\"StandardMaterial3D_jln1w\"),\r\n\"name\": \"Material\",\r\n\"primitive\": 3,\r\n\"vertex_count\": 24,\r\n\"vertex_data\": PackedByteArray(0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 128, 191, 255, 127, 255, 255, 0, 0, 255, 191, 0, 0, 128, 191, 0, 0, 128, 63, 0, 0, 128, 191, 255, 127, 255, 255, 0, 0, 255, 191, 0, 0, 128, 191, 0, 0, 128, 63, 0, 0, 128, 63, 255, 127, 255, 255, 0, 0, 255, 191, 0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 128, 63, 255, 127, 255, 255, 0, 0, 255, 191, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 128, 63, 255, 127, 255, 127, 255, 127, 255, 255, 0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 128, 63, 255, 127, 255, 127, 255, 127, 255, 255, 0, 0, 128, 191, 0, 0, 128, 63, 0, 0, 128, 63, 255, 127, 255, 127, 255, 127, 255, 255, 0, 0, 128, 191, 0, 0, 128, 191, 0, 0, 128, 63, 255, 127, 255, 127, 255, 127, 255, 255, 0, 0, 128, 191, 0, 0, 128, 191, 0, 0, 128, 63, 0, 0, 255, 127, 255, 127, 255, 255, 0, 0, 128, 191, 0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 255, 127, 255, 127, 255, 255, 0, 0, 128, 191, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 255, 127, 255, 127, 255, 255, 0, 0, 128, 191, 0, 0, 128, 191, 0, 0, 128, 191, 0, 0, 255, 127, 255, 127, 255, 255, 0, 0, 128, 191, 0, 0, 128, 191, 0, 0, 128, 191, 255, 127, 0, 0, 255, 255, 255, 191, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 128, 191, 255, 127, 0, 0, 255, 255, 255, 191, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 128, 63, 255, 127, 0, 0, 255, 255, 255, 191, 0, 0, 128, 191, 0, 0, 128, 191, 0, 0, 128, 63, 255, 127, 0, 0, 255, 255, 255, 191, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 128, 191, 255, 255, 255, 127, 255, 127, 255, 255, 0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 128, 191, 255, 255, 255, 127, 255, 127, 255, 255, 0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 128, 63, 255, 255, 255, 127, 255, 127, 255, 255, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 128, 63, 255, 255, 255, 127, 255, 127, 255, 255, 0, 0, 128, 191, 0, 0, 128, 191, 0, 0, 128, 191, 255, 255, 255, 255, 255, 127, 255, 255, 0, 0, 128, 191, 0, 0, 128, 63, 0, 0, 128, 191, 255, 255, 255, 255, 255, 127, 255, 255, 0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 128, 191, 255, 255, 255, 255, 255, 127, 255, 255, 0, 0, 128, 63, 0, 0, 128, 191, 0, 0, 128, 191, 255, 255, 255, 255, 255, 127, 255, 255)\r\n}]\r\nblend_shape_mode = 0\r\nshadow_mesh = SubResource(\"ArrayMesh_kd3hq\")\r\n\r\n[sub_resource type=\"ConcavePolygonShape3D\" id=\"ConcavePolygonShape3D_0hx5e\"]\r\ndata = PackedVector3Array(1, 1, -1, -1, 1, 1, -1, 1, -1, 1, 1, -1, 1, 1, 1, -1, 1, 1, 1, -1, 1, -1, 1, 1, 1, 1, 1, 1, -1, 1, -1, -1, 1, -1, 1, 1, -1, -1, 1, -1, 1, -1, -1, 1, 1, -1, -1, 1, -1, -1, -1, -1, 1, -1, -1, -1, -1, 1, -1, 1, 1, -1, -1, -1, -1, -1, -1, -1, 1, 1, -1, 1, 1, -1, -1, 1, 1, 1, 1, 1, -1, 1, -1, -1, 1, -1, 1, 1, 1, 1, -1, -1, -1, 1, 1, -1, -1, 1, -1, -1, -1, -1, 1, -1, -1, 1, 1, -1)\r\n\r\n[node name=\"43563-asset-collection-test\" type=\"Node3D\"]\r\n\r\n[node name=\"Cube\" type=\"MeshInstance3D\" parent=\".\"]\r\nmesh = SubResource(\"ArrayMesh_uvbey\")\r\nskeleton = NodePath(\"\")\r\n\r\n[node name=\"@StaticBody3D@17978\" type=\"StaticBody3D\" parent=\".\"]\r\ntransform = Transform3D(1.07654, 0, 0, 0, 1.07654, 0, 0, 0, 1.07654, 0.00326128, -0.0227434, 0.0210888)\r\n\r\n[node name=\"CollisionShape3D\" type=\"CollisionShape3D\" parent=\"@StaticBody3D@17978\"]\r\nshape = SubResource(\"ConcavePolygonShape3D_0hx5e\")\r\n\r\n[node name=\"Collection\" type=\"Node3D\" parent=\".\"]\r\ntransform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 1.25045, 0.302781, -1.53633)\r\n\r\n[node name=\"Collection_001\" type=\"Node3D\" parent=\".\"]\r\ntransform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 1.37902, 0.303581, 1.58606)\r\n\r\n[node name=\"asset-box\" type=\"Node3D\" parent=\".\"]\r\ntransform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -1.44183, 0.258232, -1.58591)\r\n\r\n[node name=\"asset-box_001\" type=\"Node3D\" parent=\".\"]\r\ntransform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -1.32259, 0.258232, 1.56816)\r\n\r\n[node name=\"asset-box_002\" type=\"Node3D\" parent=\".\"]\r\ntransform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 2.45399, 0)\r\n",
               %{},
               {2, 60},
               60
             } = Parser.parse_tscn_scene(@gd_resource)
    end
  end
end
